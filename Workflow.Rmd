---
title: "Workflow of Inverse Model for Rooting Profiles"
author: "Rutuja"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: github_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, include = TRUE, eval = FALSE)
```

## How is this project set-up

## Prerequisite data

_*Growth data*_

_*Water Availability*_

 Soil Water Potential data -- best-fit 100 ensembles from ELM-FATES during the study period.
 This is sourced from data-package `bci.elm.fates.hydro`

### Gather all pre-requisite data in a place or two

`GLUEsetup_part1() in 1.GLUEsetup_part1_BCI.R`

 * Loads best.fit ensembles of Soil Water Potential (SWP) from bci.elm.fates.hydro::psi of a specific version (given by the "current folder")
 * Loads hypothetical rooting profiles generated by R/3.090_root_parameters_b.R
 * Loads Turgor Loss Point (TLP) data
 * Loads tree growth census dates for specific no. of intervals
 * Converts swp into a growth factor (range 0-1) using a step-fuction, such that growth factor is 0 at sp-level or community mean level Turgor Loss Point. Species wise growth factor is stores separately (sp.hydro.output.chosen)
 
Then using a combination of a range of hypothetical root profiles obtained from 2.rooting_profiles.R and SWP based growth factor ensemble simulations generate a btran time-series using equation : Btran= i=1 to i=z RootFrac_z * f(swp_z),
where f(swp_z) is a growth.factor_z based on a linear step relationship with swp_z ap species specific or community mean TLP level.

 * Calculates btran time-series by census-interval for each rooting profile for all the best.fit SWP ensemble
  + by individual species with species-specific TLP (N of btran time series == No. of species x No. of SWP ensembles x No. of root profiles)
  + at community-mean TLP (No. of btran time series == No. of SWP ensembles x No. of root profiles)
  + both community and species level btran is calculated by dropping none or one or more number of dry season months as sublists
  * Saves ELM-FATES hydro output, rooting profiles, census dates, number of intervals in a list called info, community level btran in a list named info.3, and species level btran is saved in info.2, along with sub-list names of dropped months

```{r Chunk 1.0, eval = FALSE}
source("code/4.1.1.GLUEsetup_part1_BCI.R")
GLUEsetup_part1(current.folder = "2019-10-14_5000", intervals = 5) # this can take 30 min to get btran by nsam
```

### GLUEsetup_part2()

This function stores together growth data, growth meta-data, and btran data (at community mean TLP level by dropped months) in a list named growth_by_si.info.

```{r Chunk 2, eval = FALSE}
source("code/4.1.2.GLUEsetup_part2_BCI.R")
GLUEsetup_part2(growth.type = "med", dbh.residuals = "on", solar.residuals = "off", 
                growth.selection = "size_class_predefined_cc_scaled") #"size_class_varying_non_cc") #n.ensembles = 100000
# growth.type = "med"; dbh.residuals = "on"; solar.residuals = "off"; growth.selection = "size_class_predefined_cc_scaled"
```

###GLUE_run() 

This function generates a few statistics for the fit between growth and btran:

Rsq, negative likelihood and the number of data points of growth factor that pass through 95% confidence interval of growth. TLP level and any months to drop while calculating growth factor need be specified.  Threshold (goodness.fit) as to when to calculate Rs value also needs to be specified.

```{r Chunk 3, eval = FALSE}
# This sources "code/4.2GLUErun_part2_func_BCI.R"
source("code/4.3.GLUErun_part2_BCI.R")
# splevel = "on"; goodness.fit = 0.3; drop.months = "None"
GLUE_run(splevel = "off", goodness.fit = 0.3, drop.months = "None")
GLUE_run(splevel = "off", goodness.fit = 0.3, drop.months = "Jan")
GLUE_run(splevel = "off", goodness.fit = 0.3, drop.months = "Feb")
GLUE_run(splevel = "off", goodness.fit = 0.3, drop.months = "Mar")
GLUE_run(splevel = "off", goodness.fit = 0.3, drop.months = "JanFeb")
GLUE_run(splevel = "off", goodness.fit = 0.3, drop.months = "FebMar")
GLUE_run(splevel = "off", goodness.fit = 0.3, drop.months = "JanFebMar")
GLUE_run(splevel = "on", goodness.fit = 0.3, drop.months = "None")
GLUE_run(splevel = "on", goodness.fit = 0.3, drop.months = "Jan")
GLUE_run(splevel = "on", goodness.fit = 0.3, drop.months = "Feb")
GLUE_run(splevel = "on", goodness.fit = 0.3, drop.months = "Mar")
GLUE_run(splevel = "on", goodness.fit = 0.3, drop.months = "JanFeb")
GLUE_run(splevel = "on", goodness.fit = 0.3, drop.months = "FebMar")
GLUE_run(splevel = "on", goodness.fit = 0.3, drop.months = "JanFebMar")
```

<!-- ```{r Chunk 2.4.0, eval = FALSE} -->
<!-- source("code/4.4.Best-fit_param_BCI.R") -->
<!-- # bestfit.param(splevel = "on") -->
<!-- bestfit.param(splevel = "off") -->
<!-- ``` -->
### prep.udi.calculator()

This subsets SWP-based growth factor data (species-specific or community level) to various specified time period or months: late dryseason (Mar Apr) 1997, Jan 1997, dryseason 1992 etc.
For example, restricted to early and late 1997 dry season to later calculate UDI only for this period to compare with isotopic tree Sylem sap data that is collected in early and later 1997.

```{r Chunk 4, eval = FALSE}
source("code/4.5.prep.udi.calculator.R")
# splevel = "on"; drop.months = "JanFebMar"
prep.udi.calculator(splevel = "on", drop.months = "Feb")
prep.udi.calculator(splevel = "on", drop.months = "FebMar")
prep.udi.calculator(splevel = "on", drop.months = "Mar")

prep.udi.calculator(splevel = "off", drop.months = "Feb")
prep.udi.calculator(splevel = "off", drop.months = "FebMar")
prep.udi.calculator(splevel = "off", drop.months = "Mar")
prep.udi.calculator(splevel = "off", drop.months = "None")
prep.udi.calculator(splevel = "off", drop.months = "Jan")
prep.udi.calculator(splevel = "off", drop.months = "JanFeb")
prep.udi.calculator(splevel = "off", drop.months = "JanFebMar")
```

### udi.calculator() calculates Uptake Depth Index

This calculates Uptake Depth Index and SDI (water Stress Depth Index, without taking into account total water availability) for each simulation and stores corresponding values of model Rsq, negative loLikelihood, number of data points that pass through confidence interval of growth, species and size in one data-frame named "ds.bestfit.all.Rdata"

UDI or SDI is only calculated for a simulation for which R-sq is greater than the given therehold (e.g. rsq.thresh = 0.3) and if at least 3 data-points have passed through 95% CI of growth data calculated based on (e.g. n.ci.thresh = 3)

```{r Chunk 5, eval = FALSE}
source("code/4.6.udi.calculator.R")
##---needs to be run manually on macbook for splevel = "off" and iso.subset = "off"---
# udi.calculator(splevel = "on", dryseason = "on", rsq.thresh = 0.5, iso.subset = "on") ## udi is not calculated below this rsq.thresh
# splevel = "on"; dryseason = "on"; rsq.thresh = 0.5;  n.ci.thresh = 3; iso.subset = "on"; drop.months = "JanFebMar"
udi.calculator(splevel = "on", dryseason = "jan", rsq.thresh = 0.3,
               n.ci.thresh = 3, iso.subset = "on", drop.months = "None")
udi.calculator(splevel = "on", dryseason = "jan", rsq.thresh = 0.3,
               n.ci.thresh = 3, iso.subset = "on", drop.months = "Jan")
udi.calculator(splevel = "on", dryseason = "jan", rsq.thresh = 0.3,
               n.ci.thresh = 3, iso.subset = "on", drop.months = "Feb")
udi.calculator(splevel = "on", dryseason = "jan", rsq.thresh = 0.3,
               n.ci.thresh = 3, iso.subset = "on", drop.months = "Mar")
udi.calculator(splevel = "on", dryseason = "jan", rsq.thresh = 0.3,
               n.ci.thresh = 3, iso.subset = "on", drop.months = "JanFeb")
udi.calculator(splevel = "on", dryseason = "jan", rsq.thresh = 0.3,
               n.ci.thresh = 3, iso.subset = "on", drop.months = "FebMar")
udi.calculator(splevel = "on", dryseason = "jan", rsq.thresh = 0.3,
               n.ci.thresh = 3, iso.subset = "on", drop.months = "JanFebMar")

udi.calculator(splevel = "off", dryseason = "jan", rsq.thresh = 0.3, 
               n.ci.thresh = 3, iso.subset = "on", drop.months = "None")
udi.calculator(splevel = "off", dryseason = "jan", rsq.thresh = 0.3, 
               n.ci.thresh = 3, iso.subset = "on", drop.months = "Jan")
udi.calculator(splevel = "off", dryseason = "jan", rsq.thresh = 0.3,
               n.ci.thresh = 3, iso.subset = "on", drop.months = "Feb")
udi.calculator(splevel = "off", dryseason = "jan", rsq.thresh = 0.3,
               n.ci.thresh = 3, iso.subset = "on", drop.months = "Mar")
udi.calculator(splevel = "off", dryseason = "jan", rsq.thresh = 0.3, 
               n.ci.thresh = 3, iso.subset = "on", drop.months = "JanFeb")
udi.calculator(splevel = "off", dryseason = "jan", rsq.thresh = 0.3,
               n.ci.thresh = 3, iso.subset = "on", drop.months = "FebMar")
udi.calculator(splevel = "off", dryseason = "jan", rsq.thresh = 0.3, 
               n.ci.thresh = 3, iso.subset = "on", drop.months = "JanFebMar")
```

## Summarise Uptake Depth Index by species

UDI corresponding to model with maximum Rsq, minimum negative likelihood 
median, sd, se of UDI for top 10 rsq or bottom 10 negative likeliood, that are also greater than the Rsq threshold.

```{r Chunk 6, eval = TRUE}
source("code/4.7.summarising_udi_by_sp_size.R")
# splevel = "on"; dryseason = "on"; rsq.thresh = 0.3; root.selection = "exp"; iso.subset = "on"; drop.months = "None"
# summarise.udi(splevel = "on", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "on", n.rank = 50, drop.months = "None")
# summarise.udi(splevel = "on", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "on", n.rank = 50, drop.months = "Jan")
# summarise.udi(splevel = "on", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "on", n.rank = 50, drop.months = "Feb")
# summarise.udi(splevel = "on", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "on", n.rank = 50, drop.months = "Mar")
# summarise.udi(splevel = "on", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "on", n.rank = 50, drop.months = "JanFeb")
# summarise.udi(splevel = "on", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "on", n.rank = 50, drop.months = "FebMar")
# summarise.udi(splevel = "on", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "on", n.rank = 50, drop.months = "JanFebMar")
# 
# summarise.udi(splevel = "off", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "on", n.rank = 50, drop.months = "None")
# summarise.udi(splevel = "off", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "on", n.rank = 50, drop.months = "Jan")
# summarise.udi(splevel = "off", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "on", n.rank = 50, drop.months = "Feb")
# summarise.udi(splevel = "off", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "on", n.rank = 50, drop.months = "Mar")
# summarise.udi(splevel = "off", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "on", n.rank = 50, drop.months = "JanFeb")
# summarise.udi(splevel = "off", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "on", n.rank = 50, drop.months = "FebMar")
# summarise.udi(splevel = "off", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "on", n.rank = 50, drop.months = "JanFebMar")


summarise.udi(splevel = "on", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "off", n.rank = 1000, drop.months = "None")
summarise.udi(splevel = "on", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "off", n.rank = 1000, drop.months = "Jan")
summarise.udi(splevel = "on", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "off", n.rank = 1000, drop.months = "Feb")
summarise.udi(splevel = "on", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "off", n.rank = 1000, drop.months = "Mar")
summarise.udi(splevel = "on", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "off", n.rank = 1000, drop.months = "JanFeb")
summarise.udi(splevel = "on", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "off", n.rank = 1000, drop.months = "FebMar")
summarise.udi(splevel = "on", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "off", n.rank = 1000, drop.months = "JanFebMar")

summarise.udi(splevel = "off", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "off", n.rank = 1000, drop.months = "None")
summarise.udi(splevel = "off", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "off", n.rank = 1000, drop.months = "Jan")
summarise.udi(splevel = "off", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "off", n.rank = 1000, drop.months = "Feb")
summarise.udi(splevel = "off", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "off", n.rank = 1000, drop.months = "Mar")
summarise.udi(splevel = "off", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "off", n.rank = 1000, drop.months = "JanFeb")
summarise.udi(splevel = "off", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "off", n.rank = 1000, drop.months = "FebMar")
summarise.udi(splevel = "off", dryseason = "on", rsq.thresh = 0.3, root.selection = "exp", iso.subset = "off", n.rank = 1000, drop.months = "JanFebMar")
```

## Sensitivity of UDI of deciduous species to inclusion of deciduous months

```{r Chunk 7, eval = FALSE}
source("code/4.8.Sensitivity analysis for UDI of deciduous species.R")
```


```{r Chunk 8, eval = FALSE}
source("code/10.Comparison_with_Meinzer1999.R")
iso.compare(goodness.fit = 0.3, dryseason = "on", 
            root.selection = "exp", iso.subset = "on", drop.months = "None")
iso.compare(goodness.fit = 0.3, dryseason = "on", 
            root.selection = "exp", iso.subset = "on", drop.months = "Jan")
iso.compare(goodness.fit = 0.3, dryseason = "on", 
            root.selection = "exp", iso.subset = "on", drop.months = "Feb")
iso.compare(goodness.fit = 0.3, dryseason = "on", 
            root.selection = "exp", iso.subset = "on", drop.months = "Mar")
iso.compare(goodness.fit = 0.3, dryseason = "on", 
            root.selection = "exp", iso.subset = "on", drop.months = "JanFeb")
iso.compare(goodness.fit = 0.3, dryseason = "on", 
            root.selection = "exp", iso.subset = "on", drop.months = "FebMar")
iso.compare(goodness.fit = 0.3, dryseason = "on", 
            root.selection = "exp", iso.subset = "on", drop.months = "JanFebMar")
# goodness.fit = 0.3; dryseason = "on"; root.selection = "exp"; iso.subset = "on"; drop.months = "None"
```

```{r Chunk 9, eval = FALSE}
source("code/9.6_mortality_BCI.R")
demo.graphs(level.folder = "commlevel", n.threshold = 30, dbh.residuals = "on", 
           dryseason = "on", root.selection = "on", iso.subset = "off")
# level.folder = "commlevel"; n.threshold = 30; dbh.residuals = "on";
#            dryseason = "on"; root.selection = "on"; iso.subset = "off"
```

```{r Chunk 10, eval = FALSE}
source("code/5.species_graphs_BCI.R")
source("code/13.hydraulic_traits_BCI.R")
```
