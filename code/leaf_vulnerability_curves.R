######################################################
# Purpose: run the "closure script" for each site
# Developped by: Valentine Herrmann - HerrmannV@si.edu
# R version 3.5.1 (2018-07-02)
# Modified by: Rutuja Chitra-Tarak
# Date: Aug 15, 2020
######################################################

# Clean environment ####
rm(list = ls())

# Set working directory ####
setwd(".")

# Load libraries ####
if (!require("pacman")) install.packages("pacman"); library(pacman)
pacman::p_load(ggplot2, tidyverse)
# graphics info
theme_set(theme_bw())
theme_update(text = element_text(size = 14),
             panel.grid.major = element_blank(),
             panel.grid.minor = element_blank(),
             strip.background = element_blank()
)

figures.folder.kleaf <- paste0("figures/PhenoDemoTraitsPsi/kmax_by_psi/Leaf")
if(!dir.exists(file.path(figures.folder.kleaf))) {dir.create(file.path(figures.folder.kleaf))}

# load functions ####
source("code/Closure_Script_functions_leaf.R")

# Define parameters and variables ####
site <- c("Panama")

  # load data ####
  dd <- read.table(paste0("data-raw/traits/HydraulicTraits_Kunert/", site, "_raw_hydraulics_data.csv"), h = T, sep = ",")
  # all_TLPs <- read.csv(paste0("data-raw/traits/HydraulicTraits_Kunert/", site, "/processed_trait_data/", site, "_all_traits_table_species_level.csv"))

  dd$to_split <-  paste(dd$species, dd$data.type)
  speciesN <- aggregate(dd, by = list(dd$to_split), FUN = length)
  species_list <- speciesN[which(speciesN$to_split > 5), 1]

  # Trying to fit curves with less than 6 points returns -inf for the AICcor. Are those the binned data? Would it be possible to make the bins smaller so there are more points? ####

  # first, just to make sure that things work as expected, let's print out
  # the kl column for each species
  # for (ii in 1:length(species_list)) {
  #   data_by_sp <- subset(dd, dd$to_split == species_list[ii], select = c(1:5))
  #   print(data_by_sp)
  # } # I couldn't get the list format to save as a usable .csv file, so I changed everything to dataframes

  # use these kl's as inputs to the likelihood function

  ##The most common problem you will encounter is unsuitable limits on the parameter estimates. You can tell this is happening if the fitting function returns one of the limits as the best-fit parameter estimate. For example, for the logistic function in 'R function MB' (line 14 - 20), if the lower limit of A = 0 (par_loL(A = 0)), and modelfitting_results shows the fitted value of A = 0 (modelfitting_results$A.A = 0), the actual best-fit value of A is likely below this lower limit, and the fitting function is not returning the best model fit. Unfortunately, it is impossible to set apriori parameter limits that will fit every dataset. You will need to look through your results and make sure that the parameter estimates are within the limits, and that these limits produce reasonable results. If not, adjust the limits in 'R function MB' and call the source() command again.

  pdf(file = paste0("results/", site, "_fits.pdf"),
      width = 8.5,
      height = 5,
      onefile = T)


  # Empty the data frame of the previous results
  modelfitting_results <- NULL

  for (ii in 1:length(species_list)) {
    print(paste("Species", (ii)))

    data_by_sp <- subset(dd, dd$to_split == species_list[ii], select = c(1:5))

    sp <- unique(data_by_sp$sp)

    model_parameters <- define_parameters(data_by_sp)
    # TLP_mean <- all_TLPs[all_TLPs$sp %in% sp, ]$mean_TLP_Mpa
    # TLP_sd <- all_TLPs[all_TLPs$sp %in% sp, ]$mean_TLP_Mpa_sd

    fits <- do_the_thing(input_df = data_by_sp, model_types = c(Exponential, Exponential2, Logistic, Sigmoidal), model_parameters)

    modelfitting_results <- rbind(modelfitting_results, as.data.frame(fits))

  }

  dev.off()

  problem_rows <- which(
    is.na(as.numeric(modelfitting_results$psi_kl20)) == 'TRUE' |
      is.na(as.numeric(modelfitting_results$psi_kl50)) == 'TRUE' |
      is.na(as.numeric(modelfitting_results$psi_kl80)) == 'TRUE' |
      is.na(as.numeric(modelfitting_results$psi_kl88)) == 'TRUE' |
      is.na(as.numeric(modelfitting_results$psi_kl95)) == 'TRUE'
  )

  cat(site, "has",
      length(problem_rows),
      "curve(s) with NAs: ",
      problem_rows)

  write.csv(modelfitting_results, file = paste0("results/", site, "_fits_leaf.csv"), row.names = F)



# check if there cases where the lowest AICc function gives this issue with P50 being less negative than the data range

cases_where_P50_out_of_range <- NULL
cases_where_P80_out_of_range <- NULL
cases_where_P88_out_of_range <- NULL
  # load data ####
  dd = read.table(paste0("data-raw/traits/HydraulicTraits_Kunert/", site, "_raw_hydraulics_data.csv"), h = T, sep = ",")
  modelfitting_results <- read.csv(paste0("results/", site, "_fits_leaf.csv"))

  # get best P50 for each species
  best_p50s <- by(modelfitting_results, modelfitting_results$Species, function(x) {
    x$psi_kl50[which.min(x$AICcorr)]
  })

  best_p80s <- by(modelfitting_results, modelfitting_results$Species, function(x) {
    x$psi_kl80[which.min(x$AICcorr)]
  })

  best_p88s <- by(modelfitting_results, modelfitting_results$Species, function(x) {
    x$psi_kl80[which.min(x$AICcorr)]
  })
  best_models <- by(modelfitting_results, modelfitting_results$Species, function(x) {
    as.character(x$model_type)[which.min(x$AICcorr)]
  })

  best_p88s <- subset(modelfitting_results, model_type == "Exponential")$psi_kl88
  for(sp in levels(dd$species)) {
    best_p50 <- best_p50s[[sp]]
    best_model <- best_models[[sp]]
    min_psi <- min(dd$psi[dd$species %in% sp])
    if(best_p50 < min_psi) {
      cases_where_P50_out_of_range <- rbind(cases_where_P50_out_of_range,
                                            data.frame(site, sp, best_model))
    }
  }

  for(sp in levels(dd$species)) {
    best_p80 <- best_p80s[[sp]]
    best_model <- best_models[[sp]]
    min_psi <- min(dd$psi[dd$species %in% sp])
    if(best_p80 < min_psi) {
      cases_where_P80_out_of_range <- rbind(cases_where_P80_out_of_range,
                                            data.frame(site, sp, best_model))
    }
  }
  for(sp in levels(dd$species)) {
    best_p88 <- best_p88s[[sp]]
    best_model <- best_models[[sp]]
    min_psi <- min(dd$psi[dd$species %in% sp])
    if(best_p88 < min_psi) {
      cases_where_P88_out_of_range <- rbind(cases_where_P88_out_of_range,
                                            data.frame(site, sp, best_model))
    }
  }
cases_where_P50_out_of_range
cases_where_P80_out_of_range
write.csv(cases_where_P50_out_of_range, file = paste0("results/", site, "_cases_where_P50_out_of_range.csv"), row.names = F)
write.csv(cases_where_P80_out_of_range, file = paste0("results/", site, "_cases_where_P80_out_of_range.csv"), row.names = F)

# get the best fit for each species ####


  # load data ####
  modelfitting_results <- read.csv(paste0("results/", site, "_fits_leaf.csv"))

  # get best fit parameters
  best_models <- do.call(rbind, by(modelfitting_results, modelfitting_results$Species, function(x) {
    x[which.min(x$AICcorr),]
  }))

  write.csv(best_models, file = paste0("results/", site, "_best_fits_leaf.csv"), row.names = F)



## Plot on a single page:

  modelfitting_results <- read.csv(paste0("results/", site, "_fits_leaf.csv"))
  modelfitting_results <- modelfitting_results %>%
    mutate(Species = as.character(Species),
           sp = data.type)
  m.result_by_sp <- split(modelfitting_results, f = list(modelfitting_results$Species), drop = TRUE)


  predict.list <- vector("list", length(m.result_by_sp))
  names(predict.list) <- names(m.result_by_sp)

  ## lapply on models with predict functions breaks for each model takes in different number of parameter
  ## A hack: modify models to recognise all parameters, even though not used
  Exponential.2 <- function (A, B, C = NULL, Xo = NULL, psi) {
    A * exp(-B * psi)
  }
  Exponential2.2 <- function (A, B, C, Xo = NULL, psi) {
    C + A * exp(-B * psi)
  }
  Logistic.2 <- function (A, B, C = NULL, Xo, psi) {
    A / (1 + ((psi / Xo) ^ B))
  }
  Sigmoidal.2 <- function (A, B, C = NULL, Xo, psi) {
    A / (1 + exp(-((psi - Xo) / B)))
  }
  all_models <- c(Exponential.2, Exponential2.2, Logistic.2, Sigmoidal.2)
  names(all_models) <- c("Exponential", "Exponential2", "Logistic", "Sigmoidal")

  for (ii in 1:length(species_list)) {
    print(paste("Species", (ii)))

    data_by_sp <- subset(dd, dd$to_split == species_list[ii], select = c(1:5))
    sp <- unique(data_by_sp$sp)
    model_parameters <- define_parameters(data_by_sp)

    m.result_sp <- m.result_by_sp[[unique(data_by_sp$species)]]
    ## predicting curves from the function
    m.result_by_model <- split(m.result_sp, f = list(m.result_sp$model_type), drop = TRUE)
    pred.func <- function(m.par){
      data_by_sp$model_type <- m.par$model_type
      data_by_sp$predicted <- all_models[[m.par$model_type]](A = m.par$A, B = m.par$B,
                                                             C = m.par$C, Xo = m.par$Xo,
                                                             psi = data_by_sp$psi)
      return(data_by_sp)
    }
    predict.list[[ii]] <- do.call(rbind, lapply(m.result_by_model, pred.func))

  }
  pred.df <- do.call(rbind, predict.list)
  save(pred.df, file = file.path("results/obs_vcurves_leaf.Rdata"))
  pred.df$sp.model <- paste(pred.df$sp, pred.df$model_type, sep = ".")

  pred.df <- pred.df %>%
    mutate(color = dplyr::recode_factor(as.factor(model_type), `Exponential` = "blue",
                                        `Exponential2` = "cornflowerblue",
                                        `Logistic` = "coral2", `Sigmoidal` = "darkolivegreen4")) %>%
    arrange(sp, model_type, psi)
  pred.df.1 <- pred.df %>% subset(sp %in% unique(pred.df$sp)[1:9])
  pred.df.2 <- pred.df %>% subset(sp %in% unique(pred.df$sp)[-c(1:9)])
  modelfitting_results.1 <- subset(modelfitting_results, sp %in% pred.df.1$sp)
  modelfitting_results.2 <- subset(modelfitting_results, sp %in% pred.df.2$sp)

  plot_fits_by_sp.0.5 <- ggplot(pred.df.1, aes(x = psi, y = kl)) +
    geom_point(shape = 21, color = "white", fill = "black", alpha = 0.8, size = 2) +
    geom_line(aes(x = psi, y = predicted, group = model_type, col = model_type), size = 0.5) +
    xlim(c(0, 3)) + ylim(c(0, 3)) +
    facet_wrap(. ~ sp, scales = "free_y", ncol = 3) +
    xlab("Leaf Water Potential (-MPa)") +
    ylab(expression("Leaf Hydraulic Conductance (mmol "~m^-2*s^-1*MPa^-1*")")) +
    theme(legend.position = "top", legend.title = element_blank(),
          legend.text = element_text(size = 10),
          panel.spacing.y = unit(-0.1, "lines"))

  plot_fits_by_sp.1 <- plot_fits_by_sp.0.5 +
    geom_line(data = subset(pred.df.1, model_type == "Exponential"),
              aes(x = psi, y = predicted, group = model_type, col = model_type), size = 0.5) +
    # geom_vline(data = subset(modelfitting_results.1, model_type == "Exponential"), aes(xintercept = psi_kl50), color = "gray50", linetype = "dashed", size = 0.5) +
    geom_text(data = subset(modelfitting_results.1, model_type == "Exponential"),
              aes(x = 2.9, y = 3, label = "AICc"), col = "black", size = 3, vjust = "inward", hjust = "inward", inherit.aes = FALSE, show.legend = FALSE) +
    geom_text(data = subset(modelfitting_results.1, model_type == "Exponential"),
              aes(x = 2.9, y = 2.7, label = paste0("Exp ", round(AIC, 1)), col = model_type), size = 3, vjust = "inward", hjust = "inward", inherit.aes = FALSE, show.legend = FALSE) +
    geom_text(data = subset(modelfitting_results.1, model_type == "Exponential2"),
              aes(x = 2.9, y = 2.4, label = paste0("Exp2 ", round(AIC, 1)), col = model_type), size = 3, vjust = "inward", hjust = "inward", inherit.aes = FALSE, show.legend = FALSE) +
    geom_text(data = subset(modelfitting_results.1, model_type == "Logistic"),
              aes(x = 2.9, y = 2.1, label = paste0("Log ", round(AIC, 1)), col = model_type), size = 3, vjust = "inward", hjust = "inward", inherit.aes = FALSE, show.legend = FALSE) +
    geom_text(data = subset(modelfitting_results.1, model_type == "Sigmoidal"),
              aes(x = 2.9, y = 1.8, label = paste0("Sig ", round(AIC, 1)), col = model_type), size = 3, vjust = "inward", hjust = "inward", inherit.aes = FALSE, show.legend = FALSE)
  ggsave(plot = plot_fits_by_sp.1, file.path(figures.folder.kleaf, paste0("vcurves_fits_to_data_by_sp.1.jpeg")),
         device = "jpeg", height = 5.2, width = 5, units='in')
  ggsave(plot = plot_fits_by_sp.1, file.path(figures.folder.kleaf, paste0("vcurves_fits_to_data_by_sp.1.tiff")),
         device = "tiff", height = 5.2, width = 5, units='in')

  plot_fits_by_sp.2 <- plot_fits_by_sp.0.5 %+% pred.df.2 +
    geom_line(data = subset(pred.df.2, model_type == "Exponential"),
              aes(x = psi, y = predicted, group = model_type, col = model_type), size = 0.5) +
    # geom_text(data = subset(modelfitting_results.2, model_type == "Exponential"),
    #           aes(x = 0, y = Kmax, label = "*"), col = "red", size = 6, vjust = "inward", hjust = "inward", inherit.aes = FALSE, show.legend = FALSE) +
    # geom_vline(data = subset(modelfitting_results.2, model_type == "Exponential"), aes(xintercept = psi_kl50), color = "gray50", linetype = "dashed", size = 0.5) +
    geom_text(data = subset(modelfitting_results.2, model_type == "Exponential"),
              aes(x = 2.9, y = 3, label = "AICc"), col = "black", size = 3, vjust = "inward", hjust = "inward", inherit.aes = FALSE, show.legend = FALSE) +
    geom_text(data = subset(modelfitting_results.2, model_type == "Exponential"),
              aes(x = 2.9, y = 2.7, label = paste0("Exp ", round(AIC, 1)), col = model_type), size = 3, vjust = "inward", hjust = "inward", inherit.aes = FALSE, show.legend = FALSE) +
    geom_text(data = subset(modelfitting_results.2, model_type == "Exponential2"),
              aes(x = 2.9, y = 2.4, label = paste0("Exp2 ", round(AIC, 1)), col = model_type), size = 3, vjust = "inward", hjust = "inward", inherit.aes = FALSE, show.legend = FALSE) +
    geom_text(data = subset(modelfitting_results.2, model_type == "Logistic"),
              aes(x = 2.9, y = 2.1, label = paste0("Log ", round(AIC, 1)), col = model_type), size = 3, vjust = "inward", hjust = "inward", inherit.aes = FALSE, show.legend = FALSE) +
    geom_text(data = subset(modelfitting_results.2, model_type == "Sigmoidal"),
              aes(x = 2.9, y = 1.8, label = paste0("Sig ", round(AIC, 1)), col = model_type), size = 3, vjust = "inward", hjust = "inward", inherit.aes = FALSE, show.legend = FALSE)
  ggsave(plot = plot_fits_by_sp.2, file.path(figures.folder.kleaf, paste0("vcurves_fits_to_data_by_sp.2.jpeg")),
         device = "jpeg", height = 6.7, width = 5, units='in')
  ggsave(plot = plot_fits_by_sp.2, file.path(figures.folder.kleaf, paste0("vcurves_fits_to_data_by_sp.2.tiff")),
         device = "tiff", height = 6.7, width = 5, units='in')
